<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SWGOH Character Filter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    #scrollTopBtn {
      position: fixed;bottom: 30px;right: 30px;z-index: 1000;display: none;
      background-color: #007bff;color: white;border: none;border-radius: 50%;
      width: 50px;height: 50px;font-size: 1.5rem;cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);transition: background 0.3s;
    }
    #scrollTopBtn:hover {background-color: #0056b3;}
    body {font-family: Arial, sans-serif;background-color: #121212;color: white;margin: 0;}
    #sidebar {
      position: fixed;top: 0;left: 0;height: 100vh;width: 400px;
      background: #1b1b1b;padding: 20px;overflow-y: auto;border-right: 2px solid #333;
    }
    #content {margin-left: 500px;padding: 20px;}
    #filter-title {font-size: 1.6rem;text-align: center;margin-bottom: 25px;font-weight: bold;}
    .filter-box {background: #222;padding: 15px;border-radius: 10px;margin-bottom: 25px;}
    .filter-box h5 {margin-bottom: 10px;font-size: 1rem;font-weight: bold;color: #ddd;
      border-bottom: 1px solid #444;padding-bottom: 5px;}
    .category-grid {display: grid;grid-template-columns: 1fr;gap: 8px;max-height: 200px;overflow-y: auto;}
    .category-grid label {display: flex;align-items: center;font-size: 0.9rem;
      background: #1a1a1a;padding: 6px 10px;border-radius: 6px;cursor: pointer;}
    .category-grid input {margin-right: 6px;}
    #results {display: flex;flex-wrap: wrap;gap: 20px;justify-content: flex-start;}
    .card {width: 220px;background-color: #1e1e1e;border-radius: 12px;overflow: hidden;text-align: center;color: #f1f1f1;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);transition: transform 0.2s;}
    .card:hover {transform: scale(1.03);}
    .card img {width: 60%;height: auto;margin: 10px auto;display: block;border-bottom: 1px solid #333;object-fit: cover;}
    .card-body {padding: 12px;}
    .card-body h5 {margin-bottom: 8px;font-size: 1.1rem;font-weight: bold;}
    .btn-primary {margin-top: 8px;width: 100%;border-radius: 8px;font-weight: bold;}
    .lang-toggle {display:flex;justify-content:center;gap:10px;margin-bottom:15px;}
    .lang-toggle img {cursor:pointer;width:32px;height:32px;border-radius:50%;border:2px solid transparent;}
    .lang-toggle img.active {border-color:#007bff;}
  </style>
</head>
<body>
  <!-- Sidebar (Filtres) -->
  <div id="sidebar">
    <div id="filter-title">Ship Filter</div>

    <!-- Switch langue -->
    <div class="lang-toggle">
      <img src="https://flagcdn.com/us.svg" alt="English" id="lang-en" class="active">
      <img src="https://flagcdn.com/fr.svg" alt="Français" id="lang-fr">
    </div>

    <div class="filter-box">
      <h5>Factions</h5>
      <div class="category-grid" id="faction-filters"></div>
    </div>

    <div class="filter-box">
      <h5>Role & Alignment</h5>
      <div class="mb-2">
        <select id="role-filter" class="form-select">
          <option value="">-- role --</option>
          <option value="attacker">attacker / attaquant</option>
          <option value="support">support / soutien</option>
          <option value="healer">healer / soigneur</option>
          <option value="tank">tank / tank</option>
        </select>
      </div>
      <div>
        <select id="alignment-filter" class="form-select">
          <option value="">-- alignment --</option>
          <option value="lightside">lightside / coté lumineux</option>
          <option value="darkside">darkside / coté obscur</option>
          <option value="neutral">neutral / neutre</option>
        </select>
      </div>
    </div>

    <div class="filter-box">
      <h5>Search</h5>
      <input type="text" id="search-bar" class="form-control mb-2" placeholder="Search character...">
      <div class="input-group mb-2">
        <input type="text" id="tag-input" class="form-control" placeholder="Add a tag..." list="tag-suggestions">
        <button id="add-tag-btn" class="btn btn-secondary">Add</button>
      </div>
      <datalist id="tag-suggestions"></datalist>
      <button id="reset-filters" class="btn btn-danger w-100">Reset Filters</button>
    </div>

    <button id="scrollTopBtn" title="Back to top">↑</button>
  </div>

  <!-- Main content (Résultats) -->
  <div id="content">
    <h4>Results:</h4>
    <div id="active-filters" class="mb-3"></div>
    <div id="results"></div>
  </div>

  <script>
    const scrollBtn = document.getElementById("scrollTopBtn");
    window.addEventListener("scroll", () => {
      scrollBtn.style.display = document.documentElement.scrollTop > 200 ? "block" : "none";
    });
    scrollBtn.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));

    let characters = [];
    let customTags = [];
    let currentLang = "en"; // langue par défaut

    // Définition des priorités (EN + FR)
    const factionPriority = {
      "capital ship": 1,
      "vaisseau amiral": 1,
    };

    fetch("ship.json")
      .then(res => res.json())
      .then(data => {
        characters = data;
        generateFactionFilters();
        updateTagSuggestions();
        applyFilters();
      })
      .catch(err => {
        console.error("Error loading JSON:", err);
        document.getElementById("results").innerHTML = "<p>Error loading characters</p>";
      });

    // Langue toggle
    document.getElementById("lang-en").addEventListener("click", () => {
      currentLang = "en";
      document.getElementById("lang-en").classList.add("active");
      document.getElementById("lang-fr").classList.remove("active");
      generateFactionFilters();
      updateTagSuggestions();
      applyFilters();
    });
    document.getElementById("lang-fr").addEventListener("click", () => {
      currentLang = "fr";
      document.getElementById("lang-fr").classList.add("active");
      document.getElementById("lang-en").classList.remove("active");
      generateFactionFilters();
      updateTagSuggestions();
      applyFilters();
    });

    function generateFactionFilters() {
      const container = document.getElementById("faction-filters");
      const factionsSet = new Set();
      characters.forEach(c => (c.factions || []).forEach(f => factionsSet.add(f[currentLang] || f.en)));
      const factionsArray = Array.from(factionsSet).sort((a, b) => {
        const pa = factionPriority[a.toLowerCase()] ?? 999;
        const pb = factionPriority[b.toLowerCase()] ?? 999;
        if (pa === pb) return a.localeCompare(b, currentLang);
        return pa - pb;
      });
      container.innerHTML = "";
      factionsArray.forEach(f => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="filter" value="${f.toLowerCase()}"> ${f}`;
        container.appendChild(label);
      });
      document.querySelectorAll(".filter").forEach(cb => cb.addEventListener("change", applyFilters));
    }

    function updateTagSuggestions() {
      const datalist = document.getElementById("tag-suggestions");
      datalist.innerHTML = "";
      const factions = new Set();
      characters.forEach(c => (c.factions || []).forEach(f => factions.add(f[currentLang] || f.en)));
      const roles = ["attacker","support","healer","tank"];
      const alignments = ["lightside","darkside","neutral"];
      const allTags = [...factions].map(f => f.toLowerCase()).concat(roles, alignments);
      allTags.sort().forEach(tag => {
        const option = document.createElement("option");
        option.value = tag;
        datalist.appendChild(option);
      });
    }

    function normalizeAlignment(a) {
      if (!a) return "";
      const t = String(a).trim().toLowerCase().replace(/[\s_-]/g, "");
      if (t.startsWith("light")) return "lightside";
      if (t.startsWith("dark")) return "darkside";
      if (t.startsWith("neutral") || t.startsWith("unaligned")) return "neutral";
      return t;
    }

    function applyFilters() {
      const selectedFactions = Array.from(document.querySelectorAll(".filter:checked")).map(cb => cb.value.toLowerCase());
      const selectedRole = document.getElementById("role-filter").value.toLowerCase();
      const selectedAlignment = normalizeAlignment(document.getElementById("alignment-filter").value);
      const searchQuery = document.getElementById("search-bar").value.trim().toLowerCase();

      const filtered = characters.filter(c => {
        const factionsNames = (c.factions || []).map(f => (f[currentLang] || f.en).toLowerCase());
        const matchFactions = selectedFactions.length === 0 || selectedFactions.every(f => factionsNames.includes(f));
        const roleName = (c.role?.[currentLang] || c.role?.en || "").toLowerCase();
        const alignmentName = normalizeAlignment(c.alignment?.[currentLang] || c.alignment?.en || "");
        const matchRole = !selectedRole || roleName === selectedRole;
        const matchAlignment = !selectedAlignment || alignmentName === selectedAlignment;
        const name = (c.name?.[currentLang] || c.name?.en || "").toLowerCase();
        const matchSearch = !searchQuery || name.includes(searchQuery);
        const matchCustomTags = customTags.length === 0 || customTags.every(tag =>
          name.includes(tag) ||
          roleName.includes(tag) ||
          alignmentName === tag ||
          factionsNames.some(f => f.includes(tag))
        );
        return matchFactions && matchRole && matchAlignment && matchSearch && matchCustomTags;
      });

      renderActiveFilters(selectedFactions, selectedRole, selectedAlignment, searchQuery, customTags);
      renderCharacters(filtered);
    }

    function renderCharacters(list) {
      const container = document.getElementById("results");
      container.innerHTML = list.length
        ? list.map(c => {
          const name = c.name?.[currentLang] || c.name?.en || "";
          const role = c.role?.[currentLang] || c.role?.en || "";
          const alignment = c.alignment?.[currentLang] || c.alignment?.en || "";
          const factions = (c.factions || [])
            .map(f => f[currentLang] || f.en)
            .sort((a, b) => {
              const pa = factionPriority[a.toLowerCase()] ?? 999;
              const pb = factionPriority[b.toLowerCase()] ?? 999;
              if (pa === pb) return a.localeCompare(b, currentLang);
              return pa - pb;
            })
            .join(", ");
          return `
          <div class="card">
            <img src="${c.image}" alt="${name_vaisseau}">
            <div class="card-body">
              <h5>${name_vaisseau}</h5>
              <p><strong>ID_vaisseau:</strong> ${c.id}</p>
              <p><strong>Role_vaisseau:</strong> ${role}</p>
              <p><strong>Factions_vaisseau:</strong> ${factions}</p>
              <p><strong>Alignment_vaisseau:</strong> ${alignment}</p>
              <a href="${c.page}" class="btn btn-primary">Details</a>
            </div>
          </div>`;
        }).join("")
        : "<p>No characters found</p>";
    }

    function renderActiveFilters(selectedFactions, selectedRole, selectedAlignment, searchQuery, customTags) {
      const container = document.getElementById("active-filters");
      container.innerHTML = "";
      let filters = [];
      selectedFactions.forEach(f => filters.push({ type: "faction", value: f }));
      if (selectedRole) filters.push({ type: "role", value: selectedRole });
      if (selectedAlignment) filters.push({ type: "alignment", value: selectedAlignment });
      if (searchQuery) filters.push({ type: "search", value: searchQuery });
      customTags.forEach(tag => filters.push({ type: "custom", value: tag }));
      if (filters.length === 0) return;
      const phrase = document.createElement("p");
      phrase.innerHTML = `Characters with the tag(s): `;
      container.appendChild(phrase);
      filters.forEach(f => {
        const badge = document.createElement("span");
        badge.className = "badge bg-primary me-2";
        badge.style.cursor = "pointer";
        badge.textContent = f.value;
        badge.addEventListener("click", () => {
          if (f.type === "faction") {
            document.querySelector(`.filter[value="${f.value}"]`).checked = false;
          } else if (f.type === "role") {
            document.getElementById("role-filter").value = "";
          } else if (f.type === "alignment") {
            document.getElementById("alignment-filter").value = "";
          } else if (f.type === "search") {
            document.getElementById("search-bar").value = "";
          } else if (f.type === "custom") {
            customTags = customTags.filter(tag => tag !== f.value);
          }
          applyFilters();
        });
        container.appendChild(badge);
      });
    }

    document.getElementById("add-tag-btn").addEventListener("click", () => {
      const input = document.getElementById("tag-input");
      const tag = input.value.trim().toLowerCase();
      if (tag && !customTags.includes(tag)) {
        customTags.push(tag);
        input.value = "";
        applyFilters();
      }
    });

    document.getElementById("tag-input").addEventListener("keypress", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("add-tag-btn").click();
      }
    });

    document.getElementById("role-filter").addEventListener("change", applyFilters);
    document.getElementById("alignment-filter").addEventListener("change", applyFilters);
    document.getElementById("search-bar").addEventListener("input", applyFilters);

    document.getElementById("reset-filters").addEventListener("click", () => {
      document.querySelectorAll(".filter").forEach(cb => cb.checked = false);
      document.getElementById("role-filter").value = "";
      document.getElementById("alignment-filter").value = "";
      document.getElementById("search-bar").value = "";
      customTags = [];
      applyFilters();
    });
  </script>
</body>
</html>
